// schema.prisma (Postgres)
generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            Int            @id @default(autoincrement())
  email         String         @unique
  password      String
  role          UserRole       @default(PROSPECT) // PROSPECT | COACH | ADMIN
  name          String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  coachProfile  CoachProfile?
  clientProfile ClientProfile?
  messagesSent  Message[]      @relation("senderMessages")
  medias        Media[]
  adminReviews  AdminReview[]
}

enum UserRole {
  PROSPECT
  COACH
  ADMIN
}

model CoachProfile {
  id             Int             @id @default(autoincrement())
  userId         Int             @unique
  user           User            @relation(fields: [userId], references: [id])
  bio            String?
  discipline     String
  portfolio      String? // free text / resume
  status         ApprovalStatus  @default(PENDING) // PENDING, APPROVED, REJECTED
  statusReason   String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  media          Media[]
  chatsAsCoach   Chat[]          @relation("coachChats")
  adminReviews   AdminReview[]
  commissionLogs CommissionLog[]
}

model ClientProfile {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique
  user      User     @relation(fields: [userId], references: [id])
  ageRange  String? // e.g., "25-34"
  heightCm  Int?
  weightKg  Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  chats     Chat[]   @relation("clientChats")
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

model Media {
  id          Int           @id @default(autoincrement())
  ownerId     Int?
  owner       User?         @relation(fields: [ownerId], references: [id])
  coachId     Int?
  coach       CoachProfile? @relation(fields: [coachId], references: [id])
  url         String // S3 URL or CDN URL
  type        MediaType
  mimeType    String
  sizeBytes   Int?
  description String?
  createdAt   DateTime      @default(now())
}

enum MediaType {
  CERTIFICATE
  IMAGE
  VIDEO
  OTHER
}

model Chat {
  id        Int           @id @default(autoincrement())
  coachId   Int
  coach     CoachProfile  @relation("coachChats", fields: [coachId], references: [id])
  clientId  Int
  client    ClientProfile @relation("clientChats", fields: [clientId], references: [id])
  messages  Message[]
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@index([coachId])
  @@index([clientId])
}

model Message {
  id        Int      @id @default(autoincrement())
  chatId    Int
  chat      Chat     @relation(fields: [chatId], references: [id])
  senderId  Int
  sender    User     @relation("senderMessages", fields: [senderId], references: [id])
  content   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}

model AdminReview {
  id        Int          @id @default(autoincrement())
  coachId   Int
  coach     CoachProfile @relation(fields: [coachId], references: [id])
  adminId   Int
  admin     User         @relation(fields: [adminId], references: [id])
  action    ReviewAction
  comment   String?
  createdAt DateTime     @default(now())
}

enum ReviewAction {
  APPROVED
  REJECTED
  PENDING
}

model CommissionLog {
  id        Int          @id @default(autoincrement())
  coachId   Int
  coach     CoachProfile @relation(fields: [coachId], references: [id])
  amount    Decimal      @db.Decimal(10, 2)
  reference String? // external reference when payments are integrated
  note      String?
  createdAt DateTime     @default(now())
}
