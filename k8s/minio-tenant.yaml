---
# MinIO Operator Namespace
apiVersion: v1
kind: Namespace
metadata:
  name: minio-operator

---
# MinIO Tenant Namespace (separate from operator)
apiVersion: v1
kind: Namespace
metadata:
  name: minio-system

---
# Secret for MinIO Root User Credentials
# IMPORTANT: In production, use a secrets management solution (Sealed Secrets, Vault, AWS Secrets Manager)
# Replace 'minioadmin' with strong credentials and rotate regularly
apiVersion: v1
kind: Secret
metadata:
  name: minio-credentials
  namespace: minio-system
type: Opaque
stringData:
  MINIO_ROOT_USER: minioadmin
  MINIO_ROOT_PASSWORD: miniochangeme123 # Change this to a strong password!

---
# Secret for MinIO Tenant User (for application access)
# This user will have restricted bucket access (least privilege)
apiVersion: v1
kind: Secret
metadata:
  name: minio-app-user
  namespace: minio-system
type: Opaque
stringData:
  MINIO_USER: mandara-app
  MINIO_PASSWORD: mandara-app-secret-password-change-me # Change this!

---
# MinIO Tenant Configuration
# This creates a distributed MinIO cluster with 4 servers and 1 disk per server
# For higher availability, increase servers and disks per server
apiVersion: minio.min.io/v2
kind: Tenant
metadata:
  name: mandara-minio
  namespace: minio-system
spec:
  image: minio/minio:latest
  imagePullPolicy: IfNotPresent
  credsSecret:
    name: minio-credentials

  # Specify number of MinIO servers (minimum 4 for erasure coding)
  servers: 4

  # Volume configuration
  volumesPerServer: 1
  resources:
    requests:
      memory: 512Mi
      cpu: 250m
    limits:
      memory: 2Gi
      cpu: 1000m

  # Storage class (use fast-ssd for production, standard for dev)
  storageClassName: standard

  # Persistent volume per server
  volumeClaimTemplate:
    metadata:
      name: data
    spec:
      accessModes:
        - ReadWriteOnce
      resources:
        requests:
          storage: 50Gi # Adjust based on your needs

  # Console (MinIO UI)
  console:
    replicas: 1
    resources:
      requests:
        memory: 128Mi
        cpu: 100m
      limits:
        memory: 512Mi
        cpu: 500m

  # Security context
  securityContext:
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000

  # Environment variables for production settings
  env:
    - name: MINIO_BROWSER
      value: "on"
    - name: MINIO_PROMETHEUS_URL
      value: http://prometheus:9090 # Optional: for monitoring
    - name: MINIO_PROMETHEUS_JOB_ID
      value: mandara-minio

---
# Service for MinIO API (S3 endpoint)
apiVersion: v1
kind: Service
metadata:
  name: mandara-minio
  namespace: minio-system
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 9000
      targetPort: 9000
  selector:
    v1.min.io/tenant: mandara-minio

---
# Service for MinIO Console (web UI)
apiVersion: v1
kind: Service
metadata:
  name: mandara-minio-console
  namespace: minio-system
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 9001
      targetPort: 9001
  selector:
    v1.min.io/console: mandara-minio

---
# Ingress for MinIO S3 API (HTTPS with TLS)
# Requires cert-manager to be installed and configured
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: mandara-minio-api
  namespace: minio-system
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod # Or your issuer name
    nginx.ingress.kubernetes.io/proxy-body-size: "50m" # Allow large uploads
spec:
  ingressClassName: nginx # Change if using different ingress controller
  tls:
    - hosts:
        - minio.mandara-fitness.com # Change to your domain
      secretName: minio-api-tls
  rules:
    - host: minio.mandara-fitness.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: mandara-minio
                port:
                  number: 9000

---
# Ingress for MinIO Console (HTTPS with TLS)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: mandara-minio-console
  namespace: minio-system
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - minio-console.mandara-fitness.com
      secretName: minio-console-tls
  rules:
    - host: minio-console.mandara-fitness.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: mandara-minio-console
                port:
                  number: 9001

---
# ConfigMap for MinIO bucket and user setup job
# This is optional; you can also use MinIO admin API or console to create buckets/users
apiVersion: v1
kind: ConfigMap
metadata:
  name: minio-init-script
  namespace: minio-system
data:
  init-buckets.sh: |
    #!/bin/bash
    set -e

    # Wait for MinIO to be ready
    sleep 10

    # Create bucket for Mandara Fitness media
    mc alias set minio https://mandara-minio:9000 minioadmin miniochangeme123 --insecure
    mc mb --ignore-existing minio/mandara-media

    # Create application user with restricted access to mandara-media bucket
    mc admin user add minio mandara-app mandara-app-secret-password-change-me

    # Attach policy to user
    echo '{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Action":["s3:*"],"Resource":["arn:aws:s3:::mandara-media","arn:aws:s3:::mandara-media/*"]}]}' | \
    mc admin policy create minio mandara-policy /dev/stdin

    mc admin policy attach minio mandara-policy --user=mandara-app

    echo "MinIO initialization complete!"
